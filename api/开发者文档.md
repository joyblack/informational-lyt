# 简介
大西南项目的用户系统解析，以及设计原理。

* 注意更新时间，修改数据切记记住修改更新时间。

# 前言：接口设计
## 关于名称
**name**字段是敏感字段，所以在系统中废除了。
但是这个属性其实是很多记录的通用属性，可谓弃之可惜。因此为了保留一定的特性，在使用名称获取数据的请求上，我们都使用`name`作为请求参数。而其他的请求接口上，还是和具体的实体语义协调一致请求才行。例如，请求用户列表的时候，用户姓名这个查询的key应该为`username`而不是`name`，请诸君注意。
* 获取煤矿平台/集团列表的时候，若使用**department/getCompanyList**，则会包含集团信息一起返回；而是用**department/getCmPlatformList**则只会返回煤矿平台的列表；

# 1、部门设计
## 1.1、初版
首先，用户和职工是两个不同的概念，但是他们共享同一个部门架构。既然如此，就将整个系统映射为一棵部门树即可。

``` 
|- 集团
|-- -- 集团部门层级1
|-- -- 集团部门层级2
|-- -- ...
|-- -- 集团部门层级n
|-
|- 煤矿平台1
|- 煤矿平台2
|- 煤矿平台3
|- ...
|- 煤矿平台n
|-- -- 煤矿部门层级1
|-- -- 煤矿部门层级2
|-- -- ...
|-- -- 煤矿部门层级n
```
首先为了区别集团和煤矿，我们需要一个标志字段标明该资源属于哪一种类型，即:
```
DEPARTMENT_TYPE = {
    COMPANY_GROUP("集团公司所属部门"),
    CM_PLATFORM("煤矿平台所属部门");
}
```

那么，显然系统中需要标志几个元素，我们只需按如下的规则判断即可

* 集团的对应记录 —— 父部门为0，资源类型为0(COMPANY_GROUP)
* 集团子部门对应的记录 —— 父部门不为0，资源类型为0(COMPANY_GROUP)
* 煤矿平台的对应记录 —— 父部门为0，资源类型为1(CM_PLATFORM)
* 煤矿平台的子部门对应的记录 —— 父部门不为0，资源类型为1(CM_PLATFORM)

# 2、用户系统设计
## 2.1、简介
用户系统和职工需要区分开来，默认情况下，只有一个超级管理员账号，其等价于平台账号。平台账号拥有最高权限，可以对系统中的任何资源进行操控，默认情况下，我们将其设置为(admin:admin)。

初始阶段，超管可以通过煤矿平台管理页面创建煤矿平台。这时候，会生成3个元素：

* 元素一：煤矿平台的记录信息；
* 元素二：煤矿平台对应的顶层部门信息；
* 元素三：煤矿平台对应的管理用户信息，并将该用户的所属部门设置为该煤矿平台顶层部门的一个用户；

## 2.2、权限设计
权限可以通过角色和自定义方式进行构建。角色只不过是为了更快的绑定权限而使用，最终都会落到具体的权限上。用户不会和角色进行绑定，统一使用一个字段去设置权限。

一些大模块从功能性上杜绝某类用户访问，这时候无需进行权限验证，只需对用户类型进行判断即可。目前用户类型分为：平台管理、集团管理。例如，设备模块是不允许集团用户访问的，员工审核是不允许平台管理用户访问的。这些都无需进行所谓的权限验证，直接判断用户类型即可。

下面列出对用户类型进行具体限制表格，未列出的代表，二者均可访问。

|模块|可访问用户类型(CP-集团 CM-煤矿平台)|
|-|-|-|
|设置-创建煤矿平台|CP|


# 3、日报
## 3.1、打孔日报
* 打孔日报具有不可重复性，判别重复的标准是：同一日期、同一班次、同一队伍不能同时一样，这样的记录应该是用作修改的。

# 职工系统设计
职工系统只需单纯的管理职工信息即可。

# 4、权限控制
* 集团公司进入界面可以看到所有数据，煤矿平台看到的是和自己相关的，这是角色控制；
* 其次，深层次的权限控制通过资源列表实现。
* 后台通过资源ID和用户的权限字段进行匹配，若不包含该资源ID，则不允许进行操作；


# 1、接口调用
## 1.1、调用地址
各接口的调用模板：**{server:port}/{project}/{version}/{module}/{method}**
* server:port： 根据服务器环境进行设置，例如: 127.0.0.1:8090
* project： 根据具体的项目名进行设置，例如：informational-dxn
* version： 当前接口的版本号，例如：v1
* module： 当前调用接口所属模块，例如：user
* method： 当前调用接口的操作类型，例如：add

综上，可以得出，本项目若想添加一个用户，可使用如下的URL进行调用:
```
127.0.0.1:8090/informational-dxn/v1/user/add
```
前半部分除了端口意外其他不会变动，因此，接口文档中的调用地址，只会写调用接口的 **{module}/{method}** 部分，请留意。

* 接口请求时，数据修改为对象形式；

## 1.2、入参格式
* 时间入参的问题：统一为"yyy-MM-dd"

## 1.2、返回参数
* 如果是获取数据的接口，若提供不存在的查询条件或者ID，返回也是成功提示，但是data属性中的属性值为空。
* 接口返回时，考虑到参数名重复导致混淆的问题，数据改为嵌套对象形式；
* remark字段修改为remarks；
* 枚举类型的数据不再使用数字表示(当然也支持，不过不推荐)，而是具体的带有确切含义的英文字符串，相关的可选列表会在**参数参考表**中一一列出。

# 2、登陆
## 2.1、如何登录
登录成功后，可获取服务器返回的data字段，将其值作为以后请求的请求头的 **AUTHORIZATION-GM** 即可实现认证。


# 3、人事管理
## 3.1、员工入职
* 在同个部门下、同个职位是不允许再次入职的。
* 集团用户可以管理所有煤矿平台，煤矿平台只能管理自己所属的平台；
* 搜索阶段支持身份证号模糊搜索；

## 3.2、员工离职
* 员工离职的参保状态也要跟着人进行修改；
* 更新离职信息只允许修改下面的几个信息：只允许修改部分信息

## 3.3、员工审核
* 进入审核的条件：
    * 处于黑名单；
    * 已有职位。其他条件下均无需审核，直接入职。
    
* 不允许修改员工信息，只允许批准是否通过以及输入审核意见；

## 3.4、黑名单策略
* 员工最后一个职位离职后，才自动加入黑名单；
* 若手动添加黑名单，则必须保证员工当前不处于在职状态；
* 黑名单处显示的煤矿平台，以员工最后一个离职岗位所在的公司/平台为准。
* 若未设定黑名单解禁时间，则默认为半年（后续可考虑设置为配置项）
* 每天0点检测黑名单，解禁黑名单到期的用户，释放；
* 生成黑名单之后，会将该员工的所有待审核信息一并删除；
* 加入黑名单时，获取最新一条离职信息的操作是否有效：目前手动加入黑名单不可能成功，可不考虑；

## 3.5、职位调动策略
* 必选调动时间
* 调动的职位信息从原始职位信息中复制（目前只能填写目标部门、职位等信息，那么类似工资之类的信息只能从原始职位获取了）
* 调动结果是删除选择的入职信息，新增一条结果信息；

# 4、生产管理
## 4.1、掘进工作面
* 已添加日报的工作面无法删除（必须将日报删除了，才能删工作面）
* 已掘长度和剩余长度根据关联此工作面的日报数据自动更新
* 不能使用聚合更新，因为长度可能有原始的长度，所以只能一步一步的修改；
* 添加日报之后不允许修改总长度；

## 4.2、掘进日报
* 掘进日报必须添加详情才可以在列表中展示。

## 4.3、回采工作面
* 回采工作面的已采长度不支持修改，是通过回风顺槽和运输顺槽之和取平均值得到。之后用户更新已采长度的时候，也是通过修改这两个参数实现的，前端可以进行计算显示已采长度，后端也会在使用这个计算公式重新计算并入库。需要注意的是，修改之后，日报会缺损修改这一部分的信息。

## 4.4、回采日报


## 4.5、打钻工作
* 打钻工作（drillWork）：新建打钻工作，这是最大的主体框架；
* 钻孔(drillHole)：选择打钻工作，可以为其增加钻孔，一个打钻工作可以增加多个钻孔，但至少填写一个；
* 打钻日报(drillDaily)：围绕打钻工作，可以选择（日期、班次、打钻队伍（部门））生成多条详细日报信息；
* 详细日报(drillDailyDetail)：其实就是该打钻日报具体针对其打钻工作所涉及的钻孔进行的操作，核心就是打钻的长度；
* 详细日报的打钻长度会汇总到打钻日报中。
* 当日打钻就是具体的详细信息，而当日打孔长度是其汇总信息；
* 钻孔详情修改【钻孔设计长度】的时候，若该钻孔有日报，则不允许修改；删除也是一样。

## 4.6、打钻日报
* 修改：只允许修改人数和备注信息：前面的信息非常敏感，不允许修改；
* 添加打钻日报的时候，选定了打钻工作，则会弹出该工作对应的钻孔列表，需要注意的是，此处获取的是未完成的钻孔列表。

## 4.7、打钻分析
* 实际见煤、实际止煤、实际煤厚三个参数必须等钻孔打完之后才开放填写，其他情况都会被设置为空；
* 成孔日期是指100%完成之后的日报填写时间，后期可能会添加修改信息的时候，长度达到100%也会使用当前时间作为成孔日期；


# 5、安全管理
## 5.1、安全巡检
* 整改超时是指：超过指定时间还未进行整改，这时候会将状态设置为【整改超时=YES】状态；
* 安全巡检定时任务：每天凌晨零点会进行一次查验，未整改的条目若超过了截止时间，则会设置超时时间为已超时。
* 整改状态只能从未整改 -> 已整改。
* **定时任务**：每天凌晨零点会进行一次查验，未整改的条目若超过了截止时间，则会设置超时时间为已超时。
* 变更整改状态：从已整改到未整改如何处理？(不允许反向修改，已整改的不允许修改未整改）；
* 添加整改的时候，若整改时间已经小于当前时间，毫无疑问，设置为整改超时状态。
* 每个煤矿平台只可以看到自己的巡检相关信息，以字段inspectCompany为准。

# 6、培训管理
* 培训管理处也添加了一个关于平台的信息，和部门进行联动

# 7、设备管理
## 7.1、设备列表
* 设备编辑列表，不必再显示数量；
* 若强硬删除设备信息，请将其关联的维修信息也一并删除，否则会出现问题；


## 7.2、设备维保
* 最近保养日期填写之后，将会和保养间隔时间进行共同计算，获得下次需要保养的时间点；
* 保养告警是给予保养间隔时间进行计算的，若没有填写保养时间或者保养间隔时间，都无法拥有告警功能；
* 综合上面两点，若用户同时填写了【最近保养时间】以及【保养间隔天数】，则系统需要计算下次保养的时间，并开启【告警功能】；
* 添加一条维保信息时，即更新维保时间，更新最近一次维保时间；
* 修改维保记录时，不允许修改上半部分的设备信息，只允许修改与维保相关的信息：维保时间、维保情况、维保类型、维保人员、维保详情；
* 新增维保记录时，若该设备还有旧的、未完成的维保记录，则都将其更新为【已完成】状态；因为旧信息可能是管理员未能及时更新的残留数据，那些未完成的记录其实在线下早已全部完成。
* 修改维保记录时，若维保时间不是最近的时间，说明是一条旧的维保记录，则不要对设备的维保时间等进行设置，单纯的修改原信息即可。
* 维保完成时，更新维保次数 +1 ；

# 8、资料管理
## 8.1、资料云盘
* 资料云盘的操作方式等同于云盘，切去一些复杂的功能；
* 如果资料权限是公开，集团账号可以看到所有煤矿平台的资料，煤矿平台资料看见自己的资料；
* 如果是私有，则只有本人才可以看到自己的文件；
* 重名文件则会为其添加(number)后缀；
* **belongCompanyId**需要提交的原因：若当前处于公开权限模块，并且当前的账户是集团账户，则还需提交当前操作的文件是属于哪个平台/公司。主要是由于集团可以操作其他公司的文件，导致后台不能单纯的通过当前登录的账户来判断文件的所属平台，因此需要设置该参数。
* 资料上传时，若不存在父文件夹，则不允许进行上传操作。这也意味着，进入顶层目录时，用户应该要先创建一个文件夹，在考虑上传文件操作。
* 由于上传需要指定父文件夹信息，因此上传文件接口无需定义类似权限、所属平台这些信息了；
* 公有和私有一定要注意区别，判别重名时也要考虑该参数；

## 8.2、资料借阅
* 资料借阅只有【归还截止时间】概念，没有【归还时间】概念，毕竟是线下的管理，无需填报。

## 8.3、证件管理
* 若煤矿已经存在证件信息，不允许重复添加；若有信息修改，请直接前往编辑。
* 证照只有两种类型：采矿许可证、安全生产许可证。集团公司不需要这些，但是却可以查看所有其他煤矿平台的证照数据。
* 煤矿平台


# 20、导出
* 人事模块：导出当前搜索结果下的入职列表；


# 21、数据验证
* 角度： [-360, 360]
* 已处理长度：[0, total-left]



# 问题列表
## 待处理
* 员工模块，定时任务：解除黑名单；
* 员工信息的导出；

